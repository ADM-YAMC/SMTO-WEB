@page "/Recargas"
@layout UserLayout
@inject IJSRuntime Js
<style>
    .valid.modified:not([type=checkbox]) {
        outline: none !important;
    }
</style>

@if (forms)
{
    <RadzenCard class="mt-3 ml-1 col-6 m-auto ">
        <div class="row">
            <div class="col">
                <h3>Recargar mi tarjeta</h3>
            </div>
            <div class="col">
                <i class="fab fa-cc-visa fa-2x float-right ml-2" style=" color: #0b5ed7 !important;"></i>
                <i class="fab fa-cc-mastercard fa-2x text-primary float-right"></i>
            </div>
        </div>
        <EditForm Model="@recargas" OnValidSubmit="@(()=>forms=!forms)">
            <DataAnnotationsValidator />
            <div class="border-top mt-3">
                <div class="form-group mt-2">
                    <label class=" mb-1">Numero de tarjeta</label>
                    <InputSelect @bind-Value="@recargas.IdTarjeta" class="form-control">
                        <option value="1">965-456-7876</option>
                    </InputSelect>
                </div>
            </div>
            <div class="form-group mb-2">
                <label>Recargar</label>
                <RadzenRadioButtonList @bind-Value=@value TValue="int">
                    <Items>
                        <RadzenRadioButtonListItem Text="Viajes" Value="1" />
                        <RadzenRadioButtonListItem Text="Balance" Value="2" />
                    </Items>
                </RadzenRadioButtonList>
            </div>
            @if (value == 1)
            {

                <div class="mb-1">
                    <div class="form-group">
                        <label class=" mb-1">Cantidad</label>
                        <InputNumber @bind-Value="recargas.Viajes" class="form-control"></InputNumber>
                        <ValidationMessage For=@(() => recargas.Viajes) />
                        @if (recargas.Viajes > 0)
                        {
                            <label class=" mt-2">Total a pagar: RD$@(recargas.Viajes*20).00</label>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="form-group">
                    <label>Monto</label>
                    <InputNumber @bind-Value="recargas.Balance" class="form-control"></InputNumber>
                    <ValidationMessage For=@(() => recargas.Balance) />
                </div>
                <p class="mt-1">El monto mínimo de recarga es de RD$20.00 y el máximo de RD$2,000.00</p>
            }
            @if (metodoPago.Numero_tarjeta_pago == null)
            {
                <div class="form-group">
                    <label>Metodo de pago</label>
                    <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Agregar metodo de pago</button>
                </div>
            }
            @if (digitos_finales != "")
            {
                <div class="alert alert-light">
                    <div class="row">

                        <div class="col-1 text-center">
                            <ion-icon style="font-size:30px;" name="card-sharp"></ion-icon>
                        </div>

                        <div class="col-9">
                            XXXX-XXXX-XXXX-@digitos_finales
                        </div>

                        <div class="col-2 text-center">
                            <ion-icon class="text-success" data-bs-toggle="modal" data-bs-target="#staticBackdrop" style="font-size:30px; cursor:pointer;" name="create-sharp"></ion-icon>
                            <ion-icon class="text-danger" @onclick="CloseModal" style="font-size: 30px; cursor: pointer;" name="close-sharp"></ion-icon>
                        </div>

                    </div>
                </div>
            }

            <button type="submit" class="btn btn-success float-right">Siguiente</button>
        </EditForm>
    </RadzenCard>
}
else
{
    <RadzenCard class="mt-2 ml-1 col-6 m-auto animate__animated animate__backInRight">
        <div class="col">
            <span class="text-warning" style="cursor:pointer" @onclick="@(()=>forms=!forms)"><i class="fas fa-arrow-left fa-2x mr-2 mt-2"></i></span>
            <h2 class="d-inline mb-1">Un paso mas!</h2>
            <div style="width:250px; height:270px; margin:auto; ">
                <img src="Image/undraw_confirmation_re_b6q5.svg" class="m-auto" style="z-index:30" height="270" width="250" alt="Alternate Text" />
            </div>
        </div>
        <div class="col">
            <hr class="pt-0 mt-0" />
            <div class="row pt-0 mt-0">
                <div class="col">
                    <span class="d-block">Tipo de transaccion:</span>
                    <span class="d-block">Numero de tarjeta:</span>
                </div>
                <div class="col text-right">
                    <span class="d-block">Viaje/Recarga</span>
                    <span class="d-block">98765456788</span>
                </div>
            </div>
        </div>
        <div class="col">
            <hr class="pt-0 mt-0" />
            <div class="row pt-0 mt-0">
                <div class="col">
                    <span class="d-block">Numero de viajes:</span>
                    <span class="d-block">Total pagado:</span>
                </div>
                <div class="col text-right">
                    <span class="d-block">3</span>
                    <span class="d-block text-success">RD$60.00</span>
                </div>
            </div>
        </div>
        <div class="col">
            <hr class="pt-0 mt-0" />
            <button class="btn btn-success float-right ml-3">Confirmar</button>
            <button class="btn btn-danger float-right">Cancelar</button>
        </div>
    </RadzenCard>
}



<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Metodo de pago</h5>
                <button type="button" class="btn-close" @onclick="CloseModal" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="metodoPago" OnValidSubmit="Metodo_pago">
                    <DataAnnotationsValidator />
                    <div class="form-group">
                        <label>Numero de tarjeta</label>
                        <InputText @bind-Value="metodoPago.Numero_tarjeta_pago" @oninput="SelectedCarsChanged" class="form-control"></InputText>
                        <ValidationMessage For=@(() => metodoPago.Numero_tarjeta_pago) />
                        @if (!resultado)
                        {
                            <small class="text-danger">@msj</small>
                        }

                    </div>
                    <div class="row mb-3">
                        <label for="Cardnumber">Fecha de expiración</label>
                        <div class="col">
                            <InputSelect class="form-control" @bind-Value="@metodoPago.Mes">
                                <option selected>Mes</option>
                                <option value="01">01- Enero</option>
                                <option value="02">02- Febrero</option>
                                <option value="03">03- Marzo</option>
                                <option value="04">04- Abril</option>
                                <option value="05">05- Mayo</option>
                                <option value="06">06- Junio</option>
                                <option value="07">07- julio</option>
                                <option value="08">08- Agosto</option>
                                <option value="09">09- Septiembre</option>
                                <option value="10">10- Octubre</option>
                                <option value="11">11- Noviembre</option>
                                <option value="12">12- Diciembre</option>
                            </InputSelect>
                        </div>
                        <div class="col">
                            <InputNumber @bind-Value="metodoPago.Año" placeholder="Año" list="quantities"
                                         class="form-control" min="2000" maxlength="4" step="1"></InputNumber>
                            <datalist id="quantities">
                                <option value="2022"></option>
                                <option value="2023"></option>
                            </datalist>

                        </div>
                        <div class="col">
                            <InputNumber class="form-control" placeholder="CVV" @bind-Value="metodoPago.CVV"></InputNumber>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" disabled="@(!resultado)" data-bs-dismiss="modal">Validar</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>




@code {
    int value = 1;
    Modelo.Recargas recargas = new Modelo.Recargas();
    MetodoPago metodoPago = new MetodoPago();
    string digitos_finales = "", msj;
    bool resultado = true, forms = true;

    async Task Metodo_pago()
    {
        var result = new string(metodoPago.Numero_tarjeta_pago.Reverse().Take(4).Reverse().ToArray());
        digitos_finales = result;

        resultado = await Js.InvokeAsync<bool>("fValidarTarjeta", metodoPago.Numero_tarjeta_pago);
        Console.WriteLine(resultado);

    }

    async Task SelectedCarsChanged(ChangeEventArgs e)
    {
        Console.WriteLine(e.Value);

        if (e.Value.ToString().Length >= 16)
        {
            resultado = await Js.InvokeAsync<bool>("fValidarTarjeta", e.Value);
            if (!resultado)
            {
                msj = "El numero de la tarjeta es invalido...";
            }
        }
        else
        {
            msj = "";
        }
    }

    void CloseModal()
    {
        metodoPago = new MetodoPago();
        msj = "";
        digitos_finales = "";
    }

}
